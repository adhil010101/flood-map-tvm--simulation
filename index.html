<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flood Alert — Trivandrum (Roads only)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{
    --bg:#0f1720; --panel:#0b1220; --text:#e6eef6; --muted:#9fb0c8;
    --accent:#16a34a; --danger:#ef4444; --safe:#9be7a3;
  }
  body.light{ --bg:#f6fbff; --panel:#fff; --text:#0b1220; --muted:#475569; }
  *{box-sizing:border-box}
  html,body,#map{height:100%;margin:0;padding:0}
  body{font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}

  /* left panel */
  #leftPanel {
    position:absolute; left:12px; top:12px; z-index:1500; width:380px;
    background:var(--panel); padding:12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.45);
  }
  .input, .btn { width:100%; padding:10px; margin-bottom:8px; border-radius:8px; border:0; background:#071025; color:var(--text); }
  #findBtn { background: linear-gradient(90deg,#10b981,#064e3b); font-weight:700; }
  .small{ font-size:12px; color:var(--muted); }
  .suggestions{ position:absolute; z-index:2100; background:var(--panel); border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.45); overflow:auto; max-height:220px; color:var(--text) }
  .suggestions div{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); cursor:pointer }
  .suggestions div:hover{ background: rgba(255,255,255,0.02) }

  #topControls{ position:absolute; right:12px; top:12px; z-index:1550; display:flex; flex-direction:column; gap:8px; align-items:flex-end }
  .smallBtn{ padding:8px 10px; border-radius:8px; border:0; background:#071025; color:var(--text); cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.35) }

  #legend{ position:absolute; left:12px; bottom:12px; z-index:1200; background:var(--panel); padding:10px; border-radius:10px; color:var(--muted); font-size:13px }
  #alertBanner{ position:absolute; left:50%; transform:translateX(-50%); top:12px; z-index:1600; min-width:320px; padding:12px; border-radius:10px; display:none; font-weight:700; color:white; cursor:pointer; box-shadow:0 12px 40px rgba(0,0,0,0.4) }

  /* modals */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1700; background:rgba(0,0,0,0.45) }
  .panel{ width:520px; max-height:80vh; overflow:auto; background:var(--panel); padding:14px; border-radius:12px; color:var(--text) }

  /* responsive */
  @media (max-width:720px){ #leftPanel{ width:92%; left:4% } .panel{ width:92% } }
</style>
</head>
<body>
  <div id="alertBanner"></div>

  <div id="leftPanel">
    <h3 style="margin:0 0 8px 0">Flood Alert — Trivandrum</h3>

    <label class="small">Start (type or "Current location")</label>
    <div style="display:flex;gap:8px">
      <input id="startInput" class="input" placeholder="Type start or 'Current location'">
      <button id="useCurrentBtn" class="smallBtn">Current</button>
    </div>

    <label class="small">Destination (Trivandrum)</label>
    <input id="endInput" class="input" placeholder="Type destination">

    <div style="display:flex;gap:8px">
      <button id="findBtn" class="btn">Find fast & safe route</button>
      <button id="takeSafeBtn" class="btn" style="display:none;background:var(--safe);color:#064e3b;font-weight:700">Take Safe Route</button>
    </div>

    <div id="routeInfo" class="small"></div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="reportBtn" class="smallBtn" style="background:var(--danger)">Report Flood Road</button>
      <button id="openSettingsBtn" class="smallBtn">Settings</button>
    </div>
  </div>

  <div id="topControls">
    <div id="weatherBadge" class="small" style="display:none;background:var(--panel);padding:8px;border-radius:8px;color:var(--muted)"></div>
  </div>

  <div id="legend">
    <div style="margin-bottom:6px"><b>Legend</b></div>
    <div style="display:flex;gap:8px;align-items:center"><div style="width:18px;height:10px;background:#ef4444"></div><div class="small">Flooded road</div></div>
    <div style="display:flex;gap:8px;align-items:center"><div style="width:18px;height:10px;background:var(--safe)"></div><div class="small">Safe route</div></div>
  </div>

  <div id="map"></div>

  <div id="startSuggest" class="suggestions" style="display:none"></div>
  <div id="endSuggest" class="suggestions" style="display:none"></div>

  <!-- Report modal -->
  <div id="reportModal" class="modal">
    <div class="panel">
      <h3 style="margin-top:0">Report Flooded Road</h3>
      <p class="small">Pick START point and END point on the map (exactly two clicks). Then press <b>Finish Report</b>.</p>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="pickRoadBtn" class="smallBtn">Pick on Map</button>
        <button id="finishReportBtn" class="smallBtn" style="background:var(--accent)">Finish Report</button>
        <button id="closeReportBtn" class="smallBtn" style="background:#b91c1c">Close</button>
      </div>

      <div class="small">You can also paste two coords in the input: <code>lat1,lng1;lat2,lng2</code></div>
      <input id="reportInput" class="input" placeholder="Optional: lat1,lng1;lat2,lng2">
    </div>
  </div>

  <!-- Settings modal (includes admin) -->
  <div id="settingsModal" class="modal">
    <div class="panel">
      <h3 style="margin-top:0">Settings & Admin</h3>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="toggleThemeBtn" class="smallBtn">Toggle Light/Dark</button>
        <button id="resetViewBtn" class="smallBtn">Reset View</button>
      </div>

      <hr/>

      <h4>Admin Login</h4>
      <input id="adminUser" class="input" placeholder="Admin id (default: admin)">
      <input id="adminPass" class="input" placeholder="Password (default: admin123)" type="password">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button id="adminLoginBtn" class="smallBtn" style="background:var(--accent)">Login</button>
        <button id="closeSettingsBtn" class="smallBtn" style="background:#b91c1c">Close</button>
      </div>

      <div id="adminTools" style="display:none">
        <h4>Pending Reports</h4>
        <div id="reportsList" style="max-height:170px;overflow:auto"></div>

        <hr/>
        <h4>Draw Flooded Road (Admin)</h4>
        <p class="small">Start draw => click points on map => Finish & Save</p>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="startDrawBtn" class="smallBtn">Start Draw</button>
          <button id="finishDrawBtn" class="smallBtn" style="background:var(--accent)">Finish & Save</button>
          <button id="cancelDrawBtn" class="smallBtn" style="background:#b91c1c">Cancel</button>
        </div>

        <hr/>
        <h4>Export / Import</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="exportBtn" class="smallBtn">Export Roads JSON</button>
          <button id="importBtn" class="smallBtn">Import JSON</button>
        </div>
        <textarea id="importArea" style="width:100%;height:100px" placeholder="Paste JSON here to import"></textarea>

        <hr/>
        <div id="roadsList" style="max-height:160px;overflow:auto"></div>

      </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.polylinedecorator/1.7.0/leaflet.polylineDecorator.min.js"></script>
<script>
/* ---------------- CONFIG ---------------- */
const GRAPH_HOPPER_KEY = '363c2df2-baa1-4e35-b1b9-9ceb7fc3eed1';
const ORS_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImViOTBkMjI4ZGUyNDRkMzg5MGU1ZWVkNjU0MDU0Y2MzIiwiaCI6Im11cm11cjY0In0=';
const OWM_KEY = 'ce70bf8bdb2bbf3ad192ee196735d6cf';
const VIEWBOX = '76.7,8.7,77.2,8.3';

/* ---------------- MAP ---------------- */
const bounds = L.latLngBounds([8.3,76.7],[8.7,77.2]);
const map = L.map('map',{minZoom:11,maxZoom:18,maxBounds:bounds}).setView([8.5241,76.9366],13);
const baseTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19});
const rainLayer = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,{opacity:0.6});
if(OWM_KEY) rainLayer.addTo(map);

/* ---------------- IndexedDB light wrapper ---------------- */
function openDB(name='floodDB', version=1){
  return new Promise((resolve,reject)=>{
    const r = indexedDB.open(name, version);
    r.onupgradeneeded = (e)=> {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('roads')) db.createObjectStore('roads',{keyPath:'id'});
      if(!db.objectStoreNames.contains('reports')) db.createObjectStore('reports',{keyPath:'id'});
    };
    r.onsuccess = ()=> resolve(r.result);
    r.onerror = ()=> reject(r.error);
  });
}
async function addRecord(store,obj){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readwrite');
    const os = tx.objectStore(store);
    const rq = os.add(obj);
    rq.onsuccess = ()=> res(rq.result);
    rq.onerror = ()=> rej(rq.error);
  });
}
async function putRecord(store,obj){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readwrite'); const os = tx.objectStore(store);
    const rq = os.put(obj); rq.onsuccess = ()=> res(rq.result); rq.onerror = ()=> rej(rq.error);
  });
}
async function deleteRecord(store,key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readwrite'); const os = tx.objectStore(store);
    const rq = os.delete(key); rq.onsuccess = ()=> res(); rq.onerror = ()=> rej(rq.error);
  });
}
async function getAll(store){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readonly'); const os = tx.objectStore(store);
    const rq = os.getAll(); rq.onsuccess = ()=> res(rq.result); rq.onerror = ()=> rej(rq.error);
  });
}

/* ---------------- storage caches ---------------- */
let roadsCache = [], reportsCache = [];

/* ---------------- helpers ---------------- */
function genId(){ return 'id'+Math.random().toString(36).slice(2,9); }
function showAlertMsg(txt, action){ const b = document.getElementById('alertBanner'); b.style.display='block'; b.innerText=txt; b.style.background='linear-gradient(90deg,#ef4444,#f43f5e)'; if(action){ b.style.cursor='pointer'; b.onclick = ()=>{ action(); b.style.display='none'; }; } setTimeout(()=>{ try{ b.style.display='none'; }catch(e){} },9000); }
function hideAlert(){ const b=document.getElementById('alertBanner'); b.style.display='none'; b.onclick=null; }
function showLoader(on){ /* simple - reuse alert to show loader text */ const b=document.getElementById('alertBanner'); if(on){ b.style.display='block'; b.style.background='rgba(0,0,0,0.6)'; b.innerText='Loading...'; } else hideAlert(); }

/* ----------------- render flooded roads ----------------- */
let roadLayers = {};
async function loadAndRenderRoads(){
  roadsCache = await getAll('roads') || [];
  // remove previous
  Object.values(roadLayers).forEach(l=>{ try{ map.removeLayer(l);}catch(e){} });
  roadLayers={};
  roadsCache.forEach(r=>{
    const poly = L.polyline(r.coords, { color:'#ef4444', weight:5, dashArray:'8,8' }).addTo(map);
    poly.bindPopup('Flooded road (admin)');
    roadLayers[r.id] = poly;
  });
  renderRoadsListAdmin();
}

/* ---------------- Nominatim bound search ---------------- */
async function nominatim(q){
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=6&viewbox=${VIEWBOX}&bounded=1`;
    const r = await fetch(url, { headers:{ 'Accept-Language':'en' } });
    if(!r.ok) return [];
    return await r.json();
  }catch(e){ console.warn(e); return []; }
}

/* suggestion helpers (position below inputs) */
function positionSuggest(inputEl, boxEl){
  const r = inputEl.getBoundingClientRect();
  boxEl.style.left = (r.left + window.scrollX) + 'px';
  boxEl.style.top = (r.bottom + window.scrollY + 6) + 'px';
  boxEl.style.width = r.width + 'px';
}
function attachSuggest(inputEl, boxEl){
  let timer=null;
  inputEl.addEventListener('input', ()=>{ clearTimeout(timer); const q = inputEl.value.trim(); if(!q){ boxEl.style.display='none'; boxEl.innerHTML=''; return; } timer = setTimeout(async ()=>{
    const res = await nominatim(q);
    boxEl.innerHTML='';
    if(res.length===0){ const d=document.createElement('div'); d.innerText='No results in Trivandrum'; d.style.color='var(--muted)'; boxEl.appendChild(d); }
    res.forEach(it=>{ const div = document.createElement('div'); div.innerText = it.display_name; div.onclick = ()=>{ inputEl.value = it.display_name; inputEl._latlng = [parseFloat(it.lat), parseFloat(it.lon)]; boxEl.style.display='none'; boxEl.innerHTML=''; }; boxEl.appendChild(div); });
    positionSuggest(inputEl, boxEl); boxEl.style.display='block';
  },300); });
  inputEl.addEventListener('blur', ()=>{ setTimeout(()=>{ boxEl.style.display='none'; },200); });
  window.addEventListener('resize', ()=>{ if(boxEl.style.display==='block') positionSuggest(inputEl, boxEl); });
  window.addEventListener('scroll', ()=>{ if(boxEl.style.display==='block') positionSuggest(inputEl, boxEl); });
}
attachSuggest(document.getElementById('startInput'), document.getElementById('startSuggest'));
attachSuggest(document.getElementById('endInput'), document.getElementById('endSuggest'));

/* ---------------- Current location + weather ---------------- */
let userPos=null, userMarker=null;
if(navigator.geolocation){
  navigator.geolocation.watchPosition(p=>{
    userPos = [p.coords.latitude, p.coords.longitude];
    if(!userMarker) userMarker = L.circleMarker(userPos, { radius:8, fillColor:'#06b6d4', color:'#fff', weight:2 }).addTo(map).bindPopup('You are here');
    else userMarker.setLatLng(userPos);
    // weather
    fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${userPos[0]}&lon=${userPos[1]}&appid=${OWM_KEY}&units=metric`)
      .then(r=>r.json()).then(w=>{
        const badge = document.getElementById('weatherBadge'); badge.style.display='block';
        const rain = (w.rain && w.rain['1h']) ? ` · Rain(1h): ${w.rain['1h']}mm` : '';
        badge.innerHTML = `<b>Weather</b><br>${w.main.temp}°C · Hum ${w.main.humidity}%${rain}`;
      }).catch(()=>{});
  }, e=>{ console.warn('geo', e); }, { enableHighAccuracy:true, maximumAge:5000 });
}

/* ---------------- GraphHopper + ORS routing with fallback ---------------- */
async function ghRoute(points){
  const base = 'https://graphhopper.com/api/1/route';
  const p = new URLSearchParams();
  points.forEach(pt => p.append('point', `${pt[0]},${pt[1]}`));
  p.set('vehicle','car'); p.set('points_encoded','false'); p.set('instructions','false'); p.set('key', GRAPH_HOPPER_KEY);
  const url = base + '?' + p.toString();
  const res = await fetch(url);
  if(!res.ok) throw new Error('GH failed: '+res.status);
  return res.json();
}
async function orsRoute(points){
  const base = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';
  const coords = points.map(pt => [pt[1], pt[0]]); // lon,lat
  const body = { coordinates: coords };
  const res = await fetch(base, { method:'POST', headers:{ 'Authorization': ORS_KEY, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!res.ok) throw new Error('ORS failed: '+res.status);
  return res.json();
}
async function routeWithFallback(points){
  // Try GH first; if fails, try ORS
  try{
    const g = await ghRoute(points);
    if(g.paths && g.paths.length>0) return { source:'gh', data:g };
    throw new Error('gh-no-paths');
  }catch(e){
    console.warn('GH failed, fallback to ORS', e);
    const o = await orsRoute(points);
    return { source:'ors', data:o };
  }
}

/* ---------------- route visuals and flooded-road detection ---------------- */
let mainRoute=null, altRoute=null, dangerLayers=[];
function clearRouteGraphics(){
  if(mainRoute) try{ map.removeLayer(mainRoute);}catch(e){} mainRoute=null;
  if(altRoute) try{ map.removeLayer(altRoute);}catch(e){} altRoute=null;
  dangerLayers.forEach(dl=>{ try{ map.removeLayer(dl);}catch(e){} });
  dangerLayers=[];
  hideAlert();
  document.getElementById('takeSafeBtn').style.display='none';
  document.getElementById('routeInfo').innerText='';
}
function animateDash(layer, speed=90){
  let off=0; const id=setInterval(()=>{ off=(off+1)%100; try{ layer.setStyle({ dashOffset:String(off) }); }catch(e){} }, speed); layer._ani=id; return id;
}
function drawAnimatedPolyline(points, opts){
  const pl = L.polyline(points, opts).addTo(map);
  pl._ani = animateDash(pl, 90);
  return pl;
}
function decorateArrows(poly, color){
  try{
    return L.polylineDecorator(poly, { patterns:[{offset:'6%', repeat:'10%', symbol: L.Symbol.arrowHead({ pixelSize:10, polygon:false, pathOptions:{ stroke:true, weight:2, color }})}] }).addTo(map);
  }catch(e){ return null; }
}

/* point-to-segment distance approximate (meters) */
function pointToSegmentDistance(pt,A,B){
  const lat1=A[0]*Math.PI/180, lon1=A[1]*Math.PI/180;
  const lat2=B[0]*Math.PI/180, lon2=B[1]*Math.PI/180;
  const lat3=pt[0]*Math.PI/180, lon3=pt[1]*Math.PI/180;
  const R=6371000;
  const x1=R*lon1*Math.cos(lat1), y1=R*lat1;
  const x2=R*lon2*Math.cos(lat2), y2=R*lat2;
  const x3=R*lon3*Math.cos(lat3), y3=R*lat3;
  const dx=x2-x1, dy=y2-y1;
  if(dx===0 && dy===0) return Math.hypot(x3-x1,y3-y1);
  const t = ((x3-x1)*dx + (y3-y1)*dy) / (dx*dx + dy*dy);
  const tt = Math.max(0, Math.min(1, t));
  const xc = x1 + dx*tt, yc = y1 + dy*tt;
  return Math.hypot(x3-xc, y3-yc);
}

/* detect route intersection with any flooded road */
function detectFloodedSegmentsOnRoute(routeCoords){
  const hits = [];
  roadsCache.forEach(road=>{
    // check route points proximity to each road segment; if found, collect consecutive segments
    let seg=null;
    routeCoords.forEach(pt=>{
      let near=false;
      for(let j=0;j<road.coords.length-1;j++){
        if(pointToSegmentDistance(pt, road.coords[j], road.coords[j+1]) < 25){ near=true; break; }
      }
      if(near){ if(!seg) seg=[]; seg.push(pt); } else { if(seg){ hits.push(seg); seg=null; } }
    });
    if(seg) hits.push(seg);
  });
  return hits;
}

/* ---------------- resolve place (current, coords, nominatim) ---------------- */
async function resolvePlace(text, inputEl){
  if(!text) return null;
  if(text.toLowerCase().includes('current') && userPos) return userPos;
  if(inputEl && inputEl._latlng) return inputEl._latlng;
  const m = text.match(/(-?\d+(\.\d+)?)\s*[,;]\s*(-?\d+(\.\d+)?)/);
  if(m) return [parseFloat(m[1]), parseFloat(m[3])];
  const r = await nominatim(text);
  if(r && r.length>0) return [parseFloat(r[0].lat), parseFloat(r[0].lon)];
  return null;
}

/* ---------------- main route calc (with fallback) ---------------- */
document.getElementById('findBtn').addEventListener('click', calculateAndShow);
async function calculateAndShow(){
  try{
    clearRouteGraphics();
    showLoader(true);
    const sVal = document.getElementById('startInput').value.trim();
    const eVal = document.getElementById('endInput').value.trim();
    if(!sVal || !eVal){ alert('Enter start and destination'); showLoader(false); return; }
    const start = await resolvePlace(sVal, document.getElementById('startInput'));
    const dest  = await resolvePlace(eVal, document.getElementById('endInput'));
    if(!start || !dest){ alert('Could not resolve places (Trivandrum only)'); showLoader(false); return; }

    // try GH then ORS
    let res;
    try{ res = await ghRoute([start,dest]); }
    catch(err){ try{ const ors = await orsRoute([start,dest]); res = { source:'ors', data: ors }; res._isORS=true; }catch(e){ console.error('routing fallback failed', e); alert('Route fetch failed — check GH/ORS keys & network (see console)'); showLoader(false); return; } }

    // normalize to coords array
    let coords=[];
    if(res.paths){ // GraphHopper format
      coords = res.paths[0].points.coordinates.map(c=>[c[1], c[0]]);
      // distance/time
      document.getElementById('routeInfo').innerText = `Main: ${(res.paths[0].distance/1000).toFixed(2)} km · ${(res.paths[0].time/60000).toFixed(1)} min`;
    } else if(res.features){ // ORS geojson
      coords = res.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);
      const summary = res.features[0].properties.summary || {};
      document.getElementById('routeInfo').innerText = `Main: ${(summary.distance/1000||0).toFixed(2)} km · ${((summary.duration||0)/60).toFixed(1)} mins`;
    } else {
      alert('Unknown route response'); showLoader(false); return;
    }

    mainRoute = L.polyline(coords, { color:'#1e40af', weight:6 }).addTo(map);
    decorateArrows(mainRoute,'#1e40af');
    animateDash(mainRoute,120);
    map.fitBounds(mainRoute.getBounds(), { padding:[80,80] });

    // detect flooded road intersections
    const hitSegments = detectFloodedSegmentsOnRoute(coords);
    if(hitSegments.length > 0){
      hitSegments.forEach(seg=> {
        const l = drawAnimatedPolyline(seg, { color:'#ef4444', weight:6, dashArray:'10,8' });
        dangerLayers.push(l);
      });
      showAlertMsg('⚠️ Flooded road detected on route — click to generate safe alternate', ()=> generateAlternate(coords, start, dest));
      document.getElementById('takeSafeBtn').style.display='inline-block';
      document.getElementById('takeSafeBtn').onclick = ()=> generateAlternate(coords, start, dest);
    } else {
      document.getElementById('routeInfo').innerText += ' · No flooded roads on main route';
    }

  }catch(e){ console.error(e); alert('Route fetch failed — check GH/ORS keys & network (console).'); }
  finally{ showLoader(false); }
}

/* generate alternate route by adding small detour points around detected flooded segments */
async function generateAlternate(routeCoords, start, dest){
  try{
    // find first flood hit (road)
    let hitPoint = null;
    for(const seg of detectFloodedSegmentsOnRoute(routeCoords)){
      if(seg && seg.length) { hitPoint = seg[Math.floor(seg.length/2)]; break; }
    }
    if(!hitPoint){
      alert('No flood point found to detour around');
      return;
    }
    // create two detour points (left & right) offset by ~200m
    const meters = 220;
    const lat = hitPoint[0]*Math.PI/180, lon = hitPoint[1]*Math.PI/180;
    const offsetLat = (meters/111000);
    const left = [ hitPoint[0] + offsetLat, hitPoint[1] - offsetLat ];
    const right = [ hitPoint[0] - offsetLat, hitPoint[1] + offsetLat ];

    // try GH/ORS with left, then right, pick better
    const candidates = [
      { pts: [start, left, dest] },
      { pts: [start, right, dest] }
    ];
    const results = [];
    for(const cand of candidates){
      try{
        const r = await ghRoute(cand.pts).catch(async ()=> { const o = await orsRoute(cand.pts); return { _ors:true, features: o.features, features0: o.features[0], _orsRaw:o }; });
        // normalize distance/time
        if(r.paths){
          results.push({ coords: r.paths[0].points.coordinates.map(c=>[c[1],c[0]]), dist: r.paths[0].distance, time: r.paths[0].time });
        } else if(r.features){
          const coords = r.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);
          const sum = r.features[0].properties.summary || {};
          results.push({ coords, dist: sum.distance || 0, time: (sum.duration||0)*1000 });
        }
      }catch(e){ console.warn('candidate failed', e); }
    }
    if(results.length===0){ alert('Alternate not found'); return; }
    // choose fastest
    results.sort((a,b)=> (a.time||1e12) - (b.time||1e12) );
    const best = results[0];
    if(altRoute) try{ map.removeLayer(altRoute);}catch(e){} altRoute=null;
    altRoute = L.polyline(best.coords, { color: getComputedStyle(document.documentElement).getPropertyValue('--safe').trim()||'#9be7a3', weight:6 }).addTo(map);
    animateDash(altRoute, 100);
    decorateArrows(altRoute, getComputedStyle(document.documentElement).getPropertyValue('--safe').trim()||'#9be7a3');
    map.fitBounds(altRoute.getBounds(), { padding:[80,80] });
    document.getElementById('routeInfo').innerText += ` · Safe alt shown`;
    hideAlert();
  }catch(e){ console.error('alt err', e); alert('Alternate generation failed'); }
}

/* ---------------- detect flooded roads on map and submission workflow ---------------- */
/* report flow: user clicks Report → Pick on map → click START then END → Finish Report to submit */
let reportPickMode = false;
let reportPoints = [];
document.getElementById('reportBtn').addEventListener('click', ()=>{ document.getElementById('reportModal').style.display='flex'; reportPickMode=false; reportPoints=[]; clearTempPreview(); });
document.getElementById('closeReportBtn').addEventListener('click', ()=>{ document.getElementById('reportModal').style.display='none'; reportPickMode=false; reportPoints=[]; clearTempPreview(); });
document.getElementById('pickRoadBtn').addEventListener('click', ()=>{ alert('Click START on the map, then END.'); reportPickMode = 'start'; reportPoints = []; clearTempPreview(); });

map.on('click', function(e){
  if(reportPickMode === 'start'){
    reportPoints[0] = [e.latlng.lat, e.latlng.lng];
    // preview marker
    clearTempPreview();
    tempPreview = L.marker(reportPoints[0]).addTo(map);
    reportPickMode = 'end';
    alert('Start set. Now click to set END point.');
  } else if(reportPickMode === 'end'){
    reportPoints[1] = [e.latlng.lat, e.latlng.lng];
    clearTempPreview();
    tempPreview = L.polyline(reportPoints, { color:'#f97316', weight:4, dashArray:'6,6' }).addTo(map);
    reportPickMode = false;
    alert('End set. Click Finish Report to submit.');
    document.getElementById('reportInput').value = `${reportPoints[0][0].toFixed(6)},${reportPoints[0][1].toFixed(6)};${reportPoints[1][0].toFixed(6)},${reportPoints[1][1].toFixed(6)}`;
  }
});

/* finish report button */
document.getElementById('finishReportBtn').addEventListener('click', async ()=>{
  // either parse input or use reportPoints
  const val = document.getElementById('reportInput').value.trim();
  let coords = null;
  if(val){
    const parts = val.split(';').map(s=>s.trim()).filter(Boolean);
    if(parts.length >= 2){
      coords = parts.slice(0,2).map(p=>{
        const m = p.match(/(-?\d+(\.\d+)?)\s*[,;]\s*(-?\d+(\.\d+)?)/);
        return [parseFloat(m[1]), parseFloat(m[3])];
      });
    }
  }
  if(!coords && reportPoints.length === 2) coords = reportPoints.slice();
  if(!coords || coords.length<2){ alert('Pick START & END on the map or paste two coords first'); return; }
  const rep = { id: genId(), type:'road', coords, text:'user-report', time: Date.now(), status:'pending' };
  await addRecord('reports', rep);
  document.getElementById('reportModal').style.display='none';
  alert('Report submitted — admin will review.');
  clearTempPreview();
  await refreshReportsUI();
});

/* temp preview cleanup */
let tempPreview = null;
function clearTempPreview(){ if(tempPreview){ try{ map.removeLayer(tempPreview);}catch(e){} tempPreview=null; } }

/* ---------------- Admin & Settings behavior ---------------- */
document.getElementById('openSettingsBtn').addEventListener('click', ()=> document.getElementById('settingsModal').style.display='flex');
document.getElementById('closeSettingsBtn').addEventListener('click', ()=> document.getElementById('settingsModal').style.display='none');
document.getElementById('toggleThemeBtn').addEventListener('click', ()=> { document.body.classList.toggle('light'); if(document.body.classList.contains('light')){ if(map.hasLayer(darkTiles)) map.removeLayer(darkTiles); baseTiles.addTo(map); } else { if(map.hasLayer(baseTiles)) map.removeLayer(baseTiles); darkTiles.addTo(map); } });
document.getElementById('resetViewBtn').addEventListener('click', ()=> map.setView([8.5241,76.9366],13));

/* admin login */
document.getElementById('adminLoginBtn').addEventListener('click', async ()=>{
  const id = document.getElementById('adminUser').value.trim() || 'admin';
  const pw = document.getElementById('adminPass').value.trim() || 'admin123';
  if(id === 'admin' && pw === 'admin123'){
    document.getElementById('adminTools').style.display = 'block';
    await refreshReportsUI();
    await loadAndRenderRoads();
    alert('Admin logged in');
  } else alert('Wrong credentials');
});

/* refresh reports listing in admin */
async function refreshReportsUI(){
  reportsCache = await getAll('reports') || [];
  const list = document.getElementById('reportsList');
  list.innerHTML = '';
  if(reportsCache.length === 0) { list.innerHTML = '<div class="small">No pending reports</div>'; return; }
  reportsCache.forEach(r=>{
    if(r.status && r.status !== 'pending') return;
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<b>Road report</b><br><small>${new Date(r.time).toLocaleString()}</small>`;
    const preview = document.createElement('button'); preview.className='smallBtn'; preview.style.marginLeft='8px'; preview.innerText='Preview';
    preview.onclick = ()=> previewReport(r);
    const approve = document.createElement('button'); approve.className='smallBtn'; approve.style.marginLeft='8px'; approve.style.background='var(--accent)'; approve.innerText='Approve';
    approve.onclick = async ()=> { await addRecord('roads', { id: genId(), coords: r.coords }); await deleteRecord('reports', r.id); await refreshReportsUI(); await loadAndRenderRoads(); alert('Approved and added to flooded roads'); };
    const reject = document.createElement('button'); reject.className='smallBtn'; reject.style.marginLeft='8px'; reject.style.background='#b91c1c'; reject.innerText='Reject';
    reject.onclick = async ()=> { await deleteRecord('reports', r.id); await refreshReportsUI(); alert('Report rejected'); };
    div.appendChild(preview); div.appendChild(approve); div.appendChild(reject);
    list.appendChild(div);
  });
}

/* preview report on map (center & draw) */
let previewReportLayer = null;
function previewReport(r){
  if(previewReportLayer) try{ map.removeLayer(previewReportLayer);}catch(e){}
  previewReportLayer = L.polyline(r.coords, { color:'#f97316', weight:5, dashArray:'6,6' }).addTo(map);
  map.fitBounds(previewReportLayer.getBounds(), { padding:[60,60] });
}

/* admin draw flooding roads */
let drawing=false, drawPts=[], drawPreview=null;
document.getElementById('startDrawBtn').addEventListener('click', ()=>{ drawing=true; drawPts=[]; alert('Admin: click map to add road points, then Finish & Save'); });
document.getElementById('finishDrawBtn').addEventListener('click', async ()=>{ if(drawPts.length<2){ alert('Need >=2 points'); return; } await addRecord('roads', { id: genId(), coords: drawPts.slice() }); drawing=false; if(drawPreview) try{ map.removeLayer(drawPreview);}catch(e){} drawPreview=null; await loadAndRenderRoads(); alert('Flooded road saved'); });
document.getElementById('cancelDrawBtn').addEventListener('click', ()=>{ drawing=false; drawPts=[]; if(drawPreview) try{ map.removeLayer(drawPreview);}catch(e){} drawPreview=null; alert('Canceled'); });
map.on('click', function(e){ if(drawing){ drawPts.push([e.latlng.lat, e.latlng.lng]); if(drawPreview) try{ map.removeLayer(drawPreview);}catch(e){} drawPreview = L.polyline(drawPts, { color:'#ef4444', weight:4, dashArray:'8,8' }).addTo(map); } });

/* export/import roads */
document.getElementById('exportBtn').addEventListener('click', async ()=>{ const roads = await getAll('roads'); document.getElementById('importArea').value = JSON.stringify(roads, null, 2); alert('Export placed below'); });
document.getElementById('importBtn').addEventListener('click', async ()=>{ const txt = document.getElementById('importArea').value.trim(); if(!txt) return alert('Paste JSON first'); try{ const arr = JSON.parse(txt); if(!Array.isArray(arr)) return alert('JSON must be array of roads'); for(const r of arr){ if(r.coords && Array.isArray(r.coords)) await addRecord('roads', { id: genId(), coords:r.coords }); } await loadAndRenderRoads(); alert('Imported'); }catch(e){ alert('Import error: '+e.message); } });

/* render roads list admin */
async function renderRoadsListAdmin(){
  const container = document.getElementById('roadsList');
  container.innerHTML = '';
  roadsCache.forEach(r=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<b>Road</b> ${r.coords.length} points`;
    const rm = document.createElement('button'); rm.className='smallBtn'; rm.style.float='right'; rm.style.background='#b91c1c'; rm.innerText='Remove';
    rm.onclick = async ()=> { await deleteRecord('roads', r.id); await loadAndRenderRoads(); alert('Removed'); };
    div.appendChild(rm); container.appendChild(div);
  });
}

/* wrapper to load & refresh roads & reports */
async function loadAndRenderRoads(){
  roadsCache = await getAll('roads') || [];
  Object.values(roadLayers).forEach(l=>{ try{ map.removeLayer(l);}catch(e){} });
  roadLayers={};
  roadsCache.forEach(r=>{ const poly = L.polyline(r.coords, { color:'#ef4444', weight:5, dashArray:'8,8' }).addTo(map); roadLayers[r.id]=poly; });
  renderRoadsListAdmin();
}

/* refresh reports + roads UI */
async function refreshReportsUI(){
  reportsCache = await getAll('reports') || [];
  renderReportsUIinAdmin();
}
async function renderReportsUIinAdmin(){
  const list = document.getElementById('reportsList');
  list.innerHTML = '';
  const reps = await getAll('reports') || [];
  if(reps.length===0) { list.innerHTML = '<div class="small">No pending reports</div>'; return; }
  reps.forEach(r=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<b>Road report</b><br><small>${new Date(r.time).toLocaleString()}</small>`;
    const preview = document.createElement('button'); preview.className='smallBtn'; preview.style.marginLeft='8px'; preview.innerText='Preview';
    preview.onclick = ()=> { if(window._previewReport) try{ map.removeLayer(window._previewReport);}catch(e){} window._previewReport = L.polyline(r.coords, { color:'#f97316', weight:5, dashArray:'6,6' }).addTo(map); map.fitBounds(window._previewReport.getBounds(), { padding:[60,60] }); };
    const approve = document.createElement('button'); approve.className='smallBtn'; approve.style.marginLeft='8px'; approve.style.background='var(--accent)'; approve.innerText='Approve';
    approve.onclick = async ()=>{ await addRecord('roads', { id: genId(), coords: r.coords }); await deleteRecord('reports', r.id); await loadAndRenderRoads(); await renderReportsUIinAdmin(); alert('Approved'); };
    const reject = document.createElement('button'); reject.className='smallBtn'; reject.style.marginLeft='8px'; reject.style.background='#b91c1c'; reject.innerText='Reject';
    reject.onclick = async ()=>{ await deleteRecord('reports', r.id); await renderReportsUIinAdmin(); alert('Rejected'); };
    div.appendChild(preview); div.appendChild(approve); div.appendChild(reject);
    list.appendChild(div);
  });
}

/* small helpers & startup */
function showLoader(on){ const b = document.getElementById('alertBanner'); if(on){ b.style.display='block'; b.style.background='rgba(0,0,0,0.6)'; b.innerText='Loading...'; } else b.style.display='none'; }
function showAlertMsg(text, action){ const b=document.getElementById('alertBanner'); b.style.display='block'; b.innerText=text; b.style.background='linear-gradient(90deg,#ef4444,#f43f5e)'; if(action){ b.style.cursor='pointer'; b.onclick = ()=>{ action(); b.style.display='none'; } } setTimeout(()=>{ try{ b.style.display='none'; }catch(e){} },9000); }
function hideAlert(){ const b=document.getElementById('alertBanner'); b.style.display='none'; b.onclick=null; }

/* attach start/end suggestion positioning initial */
setTimeout(()=>{ positionSuggest(document.getElementById('startInput'), document.getElementById('startSuggest')); positionSuggest(document.getElementById('endInput'), document.getElementById('endSuggest')); }, 300);

/* use current button */
document.getElementById('useCurrentBtn').addEventListener('click', ()=>{ if(userPos){ document.getElementById('startInput').value = 'Current location'; document.getElementById('startInput')._latlng = userPos; } else alert('Allow location permission'); });

/* startup: ensure DB created and load data */
(async function init(){
  await openDB();
  await loadAndRenderRoads();
  await renderReportsUIinAdmin();
})();

</script>
</body>
</html>
